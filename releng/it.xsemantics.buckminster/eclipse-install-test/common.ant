<?xml version="1.0" encoding="UTF-8"?>
<!--
		eclipse.download	The base URL for all the repositories in the RMAP
							Default: http://download.eclipse.org
-->
<project name="common" >
	<property name="eclipse.download" value="http://download.eclipse.org" />

	<property name="eclipse.base.dest" location="${user.home}/eclipse-install" />

	<property name="director.install.dest" location="${user.home}" />
	<property name="director.dir" location="${director.install.dest}/director" />
	<property name="director.url" value="http://download.eclipse.org/tools/buckminster/products/director_latest.zip" />

	<property name="eclipse.p2.mirrors" value="true" />
	<property name="java.net.preferIPv4Stack" value="true" />

	<macrodef name="install.eclipse.features">
		<attribute name="eclipse.name" default="kepler" />
		<attribute name="eclipse.version" default="4.3" />
		<attribute name="features.repos" />
		<sequential>
			<install.eclipse eclipse.name="@{eclipse.name}" eclipse.version="@{eclipse.version}"/>
			<property name="eclipse.test.dest" location="${eclipse.base.dest}/eclipse-${eclipse.name}-test" />
			<makeurl file="@{features.repos}" property="features.repos.url"/>
			<property name="all.eclipse.repos" value="${eclipse.repos},${features.repos.url}" />
			
			<echo message="Installing features into ${eclipse.test.dest}..." />
			<echo message="Features Repos: ${features.repos.url}" />
			<echo message="All used Repositories: ${all.eclipse.repos}" />
			
			<delete dir="${eclipse.test.dest}"></delete>
			
			<copy todir="${eclipse.test.dest}">
				<fileset dir="${eclipse.dest}"/>
			</copy>
		</sequential>
	</macrodef>		

	<macrodef name="install.eclipse">
		<attribute name="eclipse.name" default="kepler" />
		<attribute name="eclipse.version" default="4.3" />
		<sequential>
			<property name="eclipse.name" value="@{eclipse.name}" />
			<property name="eclipse.version" value="@{eclipse.version}" />
			<property name="eclipse.dest" location="${eclipse.base.dest}/eclipse-${eclipse.name}" />
			<property name="eclipse.repos" value="${eclipse.download}/releases/${eclipse.name},${eclipse.download}/updates/${eclipse.version}" />
			<antcall target="-install.eclipse"/>
		</sequential>
	</macrodef>		
	
	<target name="-install.eclipse">
		<condition property="eclipse.installed">
			<available file="${eclipse.dest}/.eclipseproduct" />
		</condition>
		<antcall target="install.eclipse.internal" />
	</target>

	<target name="install.eclipse.internal" unless="eclipse.installed" >
		<antcall target="install.p2.director" />
		<echo message="" />
		<echo message="Installing eclipse ${eclipse.name} into ${eclipse.dest}..." />
		<echo message="Repositories: ${eclipse.repos}" />
		<java fork="true" dir="${director.dir}" logError="true" classname="org.eclipse.core.launcher.Main" failonerror="true">
			<sysproperty key="eclipse.p2.mirrors" value="${eclipse.p2.mirrors}" />
			<sysproperty key="java.net.preferIPv4Stack" value="${java.net.preferIPv4Stack}" />
			<classpath>
				<fileset dir="${director.dir}/plugins">
					<include name="org.eclipse.equinox.launcher_*.jar" />
				</fileset>
			</classpath>
			<arg line="-r ${eclipse.repos}" />
			<arg line='-d "${eclipse.dest}"' />
			<arg line="-installIU org.eclipse.sdk.ide" />
			<arg line="-tag InitialState" />
			<arg line="-profile SDKProfile" />
			<arg line="-profileProperties org.eclipse.update.install.features=true" />
		</java>
	</target>

	<target name="install.p2.director">
		<condition property="p2.director.installed">
			<available file="${director.dir}" />
		</condition>
		<antcall target="install.p2.director.internal" />
	</target>

	<target name="install.p2.director.internal" unless="p2.director.installed">
		<echo message="" />
		<echo message="Installing director from ${director.url}..." />
		<tempfile destdir="${java.io.tmpdir}"
						          prefix="director-"
						          suffix=".zip"
						          property="director.zip"
						          deleteonexit="true" />
		<get src="${director.url}" dest="${director.zip}" />
		<unzip src="${director.zip}" dest="${director.install.dest}" />
		<delete file="${director.zip}" />
	</target>

</project>
